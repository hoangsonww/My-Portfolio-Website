# Makefile for Son Nguyen Hoang Portfolio (static site)
# ------------------------------------------------------
# Usage:
#   make [target]
# Default target is `all` which runs: lint โ build โ test-links
#
# Prerequisites:
#   - Node.js & npm
#   - optipng, jpegoptim, python3 (for http.server)
#   - rsync (for deploy)
#
# You can tweak DEST, SERVER, etc. below.

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# CONFIGURATION
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# Where to put the built site
DEST      := dist

# Remote server for `make deploy`
RSYNC_DEST   := user@your.server.com:/var/www/sonnguyenhoang.com

# Tools installed via npm
HTMLHINT     := ./node_modules/.bin/htmlhint
STYLELINT    := ./node_modules/.bin/stylelint
ESLINT       := ./node_modules/.bin/eslint
CLEANCSS     := ./node_modules/.bin/cleancss
UGLIFYJS     := ./node_modules/.bin/uglifyjs
IMAGEMIN     := ./node_modules/.bin/imagemin
LINKINATOR   := ./node_modules/.bin/linkinator

# Source directories
SRC          := .
CSS_SRC      := packages/css
JS_SRC       := packages/js
IMG_SRC      := packages/images
PDF_SRC      := packages/pdf

# File globs
HTML_FILES   := $(shell find $(SRC) -maxdepth 1 -name '*.html')
CSS_FILES    := $(shell find $(CSS_SRC) -name '*.css')
JS_FILES     := $(shell find $(JS_SRC) -name '*.js')
IMG_FILES    := $(shell find $(IMG_SRC) -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' \))

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PHONY
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
.PHONY: all setup lint lint-html lint-css lint-js build clean \
        copy-html copy-css copy-js copy-images copy-pdf \
        minify-css minify-js optimize-images test-links serve deploy

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# DEFAULT
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
all: lint build test-links
	@echo "\nโ  All tasks complete."

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# SETUP (install dev dependencies)
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
setup:
	@echo "๐ง Installing npm devโtoolsโฆ"
	npm install --save-dev \
	  htmlhint stylelint eslint \
	  clean-css-cli uglify-js imagemin-cli linkinator

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# LINT
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
lint: lint-html lint-css lint-js

lint-html:
	@echo "๐ Linting HTMLโฆ"
	$(HTMLHINT) $(HTML_FILES)

lint-css:
	@echo "๐ Linting CSSโฆ"
	$(STYLELINT) "$(CSS_SRC)/**/*.css"

lint-js:
	@echo "๐ Linting JSโฆ"
	$(ESLINT) $(JS_SRC)

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# BUILD (prep and minify)
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
build: clean copy-html copy-css copy-js copy-images copy-pdf \
       minify-css minify-js optimize-images
	@echo "๐ฆ Build complete in $(DEST)/"

clean:
	@echo "๐งน Cleaning $(DEST)/โฆ"
	rm -rf $(DEST)

copy-html:
	@echo "๐ Copying HTMLโฆ"
	mkdir -p $(DEST)
	cp $(HTML_FILES) $(DEST)/

copy-css:
	@echo "๐จ Copying CSSโฆ"
	mkdir -p $(DEST)/$(CSS_SRC)
	cp -r $(CSS_SRC)/* $(DEST)/$(CSS_SRC)/

copy-js:
	@echo "๐ป Copying JSโฆ"
	mkdir -p $(DEST)/$(JS_SRC)
	cp -r $(JS_SRC)/* $(DEST)/$(JS_SRC)/

copy-images:
	@echo "๐ผ๏ธ  Copying imagesโฆ"
	mkdir -p $(DEST)/$(IMG_SRC)
	cp -r $(IMG_SRC)/* $(DEST)/$(IMG_SRC)/

copy-pdf:
	@echo "๐ Copying PDFโฆ"
	mkdir -p $(DEST)/$(PDF_SRC)
	cp -r $(PDF_SRC)/* $(DEST)/$(PDF_SRC)/

minify-css:
	@echo "๐๏ธ  Minifying CSSโฆ"
	@for f in $(DEST)/$(CSS_SRC)/*.css; do \
	  $(CLEANCSS) -o $$f.min.css $$f; \
	  mv $$f.min.css $$f; \
	done

minify-js:
	@echo "๐๏ธ  Minifying JSโฆ"
	@for f in $(DEST)/$(JS_SRC)/*.js; do \
	  $(UGLIFYJS) $$f -c -m -o $$f.min.js; \
	  mv $$f.min.js $$f; \
	done

optimize-images:
	@echo "๐๏ธ  Optimizing imagesโฆ"
	@find $(DEST)/$(IMG_SRC) -type f -iname '*.png'  -exec optipng -o7 {} \;
	@find $(DEST)/$(IMG_SRC) -type f -iname '*.jpg' -exec jpegoptim --max=85 {} \;

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# TEST BROKEN LINKS
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
test-links:
	@echo "๐ Checking for broken linksโฆ"
	$(LINKINATOR) $(DEST) --skip ./packages/images --silent
	@echo "โ No broken links found."

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# LOCAL SERVER
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
serve:
	@echo "๐ Serving at http://localhost:8000"
	@cd $(DEST) && python3 -m http.server 8000

#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# DEPLOY (rsync)
#โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
deploy: all
	@echo "๐ Deploying to $(RSYNC_DEST)โฆ"
	rsync -avz --delete $(DEST)/ $(RSYNC_DEST)
	@echo "โ Deployed successfully!"
